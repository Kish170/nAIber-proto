generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(uuid())

  name                String
  age                 Int?
  phone               String    @unique
  gender              Gender?

  interests           String[]
  dislikes            String[]

  callFrequency       CheckInFrequency @default(DAILY)
  preferredCallTime   DateTime         @db.Time

  isFirstCall         Boolean   @default(true)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  lastCallAt          DateTime?

  emergencyContact      EmergencyContact?
  healthConditions      UserHealthCondition[]
  medications           UserMedication[]
  callLogs              CallLog[]
  conversationSummaries ConversationSummary[]
  conversationTopics    ConversationTopic[]
  healthLogs            HealthLog[]

  @@map("users")
}

model EmergencyContact {
  id                  String       @id @default(uuid())
  userId              String       @unique

  name                String
  phone               String
  email               String?
  relationship        String

  smsEnabled          Boolean @default(true)
  notifyOnMissedCalls Boolean @default(true)

  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("emergency_contacts")
}

model UserHealthCondition {
  id          String    @id @default(uuid())
  userId      String

  condition   String
  severity    String?
  diagnosedAt DateTime?
  notes       String?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, condition])
  @@index([userId, isActive])
  @@map("user_health_conditions")
}

model UserMedication {
  id         String    @id @default(uuid())
  userId     String

  name       String
  dosage     String
  frequency  String

  startedAt  DateTime?
  endedAt    DateTime?
  notes      String?
  isActive   Boolean   @default(true)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId, isActive])
  @@map("user_medications")
}

model CallLog {
  id                       String       @id @default(uuid())
  userId                   String

  scheduledTime            DateTime
  endTime                  DateTime?

  status                   CallStatus   @default(PENDING)
  outcome                  CallOutcome?

  noAnswerCount            Int          @default(0)
  retryCount               Int          @default(0)
  nextRetryTime            DateTime?

  twilioCallSid            String?
  elevenlabsConversationId String?

  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt

  user                     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationSummary      ConversationSummary?
  healthMentions           HealthLog[]

  @@index([userId, scheduledTime])
  @@index([status])
  @@index([scheduledTime])
  @@index([userId, createdAt])
  @@map("call_logs")
}

model ConversationSummary {
  id                    String   @id @default(uuid())
  userId                String
  conversationId        String   @unique

  summaryText           String
  durationMinutes       Int?

  topicsDiscussed       String[]

  keyHighlights         Json?

  createdAt             DateTime @default(now())

  user                  User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  callLog               CallLog                      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationTopicRefs ConversationTopicReference[]

  @@index([userId, createdAt])
  @@map("conversation_summaries")
}

model ConversationTopic {
  id                     String   @id @default(uuid())
  userId                 String

  topicName              String
  variations             String[]
  category               String?

  firstMentioned         DateTime @default(now())
  lastMentioned          DateTime @default(now())
  
  topicEmbedding         Float[]

//   engagement_level       String  
//   user_interest_score    Int
// add memory chains, entity and sentiment tracking

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user                   User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationReferences ConversationTopicReference[]

  @@unique([userId, topicName])
  @@index([userId, lastMentioned])
  @@index([lastMentioned])
  @@map("conversation_topics")
}

model ConversationTopicReference {
  id                    String              @id @default(uuid())
  conversationSummaryId String
  conversationTopicId   String

  mentionedAt           DateTime            @default(now())

  conversationSummary   ConversationSummary @relation(fields: [conversationSummaryId], references: [id], onDelete: Cascade)
  conversationTopic     ConversationTopic   @relation(fields: [conversationTopicId], references: [id], onDelete: Cascade)

  @@unique([conversationSummaryId, conversationTopicId])
  @@index([conversationTopicId, mentionedAt])
  @@map("conversation_topic_references")
}

model HealthLog {
  id                    String   @id @default(uuid())
  userId                String
  conversationId        String

  mentionText           String
  mentionType           String

  severity              String?
  bodyPart              String?

  surfacedToDashboard   Boolean  @default(false)
  stakeholderNotified   Boolean  @default(false)

  detectedAt            DateTime @default(now())
  notifiedAt            DateTime?

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  callLog               CallLog  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([userId, detectedAt])
  @@index([surfacedToDashboard])
  @@map("health_mentions")
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
}

enum Relationship {
  SPOUSE
  DAUGHTER
  SON
  SIBLING
  FRIEND
  CAREGIVER
  OTHER
}

enum CheckInFrequency {
  DAILY
  WEEKLY
  
}

enum CallStatus {
  PENDING          
  QUEUED           
  IN_PROGRESS      
  COMPLETED        
  FAILED           
}

enum CallOutcome {
  COMPLETED         
  NO_ANSWER         
  BUSY              
  FAILED            
  USER_ENDED_EARLY  
}

enum NotificationType {
  MISSED_CALLS          
  SYSTEM_FAILURE        
  HEALTH_CONCERN        
  WEEKLY_SUMMARY        
  MEDICATION_REMINDER   
}

enum NotificationStatus {
  PENDING    
  SENT       
  DELIVERED  
  FAILED     
}